---
title: "Longitudinal multilevel modeling of single-case data: A meta-analytic method"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    self_contained: false
    thumbnails: false
    lightbox: true
pkgdown:
  as_is: true    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    cache = TRUE,
    message = FALSE, 
    warning = FALSE)
```

This webpage contains raw datasets, outputs, and R codes used for the four-level multilevel modeling in Authors (2023). Data analysis scripts were also posted through an online data repository at <https://osf.io/8wbta/?view_only=31ca7d3193104652b39dbb4a516a5f00>.

## Datasets {.tabset}

```{r, echo=FALSE}
suppressPackageStartupMessages({
  library(kableExtra)
  library(dplyr)
  library(nlme)
  library(clubSandwich)
  library(lmeInfo)
  library(texreg)
  library(ggplot2)
})

# var_comp <- read.csv("data/var_comp.csv")
wp_data_mlm <- read.csv("data/wp_data.csv")
load("data/wp_mlm.RData")

wp_data_mlm_kb <- wp_data_mlm %>%
    kbl(align = "c") %>%
    kable_styling(
        bootstrap_options = c("striped","hover","condensed"),
        full_width = T,
        font_size = 12,
        fixed_thead = T) %>%
    scroll_box(height = "500px")
wp_data_mlm_kb
```

## Model Specification {.tabset}

### Model.1 

#### **Null model** 

```{r, eval=FALSE}
Model.1 <- lme(outcome ~ 1,
               data = wp_data_mlm,
               method = "REML",
               random = ~ 1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.1.vcov <- vcovCR(Model.1, type = "CR2")
Model.1.crve <- coef_test(Model.1, vcov = Model.1.vcov , test = "Satterthwaite")
Model.1.crve
```

#### **Variance components**
```{r}
VarCorr(Model.1)
```

#### **Intraclass correlation (ICC)** 

##### Level 4 (study) 

```{r}
total_var <- as.numeric(VarCorr(Model.1)[[2]]) +
  as.numeric(VarCorr(Model.1)[[4]]) +
  as.numeric(VarCorr(Model.1)[[6]]) +
  as.numeric(VarCorr(Model.1)[[7]]) 

ICC.L4 = as.numeric(VarCorr(Model.1)[[2]]) / total_var
ICC.L4
```

##### Level 3 (cluster) 

```{r}
ICC.L3 = (as.numeric(VarCorr(Model.1)[[4]])) / total_var
ICC.L3
```

##### Level 2 (case) 

```{r}
ICC.L2 = (as.numeric(VarCorr(Model.1)[[6]])) / total_var
format(ICC.L2, scientific=FALSE)
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.1, maxLag=15), alpha = .05)
```

### Model.2 

#### **Piecewise growth model with AR(1) correlation structure (corCAR1)**

```{r, eval=FALSE}
Model.2 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               correlation = corCAR1(value = 0.4, form = ~ session | study/cluster/case),
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))

```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.2.vcov <- vcovCR(Model.2, type = "CR2")
Model.2.crve <- coef_test(Model.2, vcov = Model.2.vcov , test = "Satterthwaite")
Model.2.crve$beta <- round(Model.2.crve$beta, 2)
Model.2.crve$SE <- round(Model.2.crve$SE, 2)
Model.2.crve$tstat <- round(Model.2.crve$tstat, 2) %>% format(Model.2.crve$tstat, scientific = FALSE)
Model.2.crve 
```

#### **Variance components**
```{r}
VarCorr(Model.2)
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.2, maxLag=15), alpha = .05)
```

### Model.3

#### **Piecewise growth model with heterogeneous AR(1) correlation structure (corCAR1)** 

```{r, eval=FALSE}
Model.3 <- update(Model.2, weights = varIdent(form = ~ 1 | phase))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.3.vcov <- vcovCR(Model.3, type = "CR2")
Model.3.crve <- coef_test(Model.3, vcov = Model.3.vcov , test = "Satterthwaite")
Model.3.crve$beta <- round(Model.3.crve$beta, 2)
Model.3.crve$SE <- round(Model.3.crve$SE, 2)
Model.3.crve$tstat <- round(Model.3.crve$tstat, 2) %>% format(Model.3.crve$tstat, scientific = FALSE)
Model.3.crve 
```

#### **Variance components**
```{r}
VarCorr(Model.3)
```

#### **Comparing likelihoods of fitted objects**

```{r}
M2_M3 <- anova(Model.2, Model.3)
M2_M3
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.3, maxLag=15), alpha = .05)
```

### Model.4

#### **Piecewise growth model with time-invariant (Level 4) predictors (cross-level interactions)**

```{r, eval=FALSE}
Model.4 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M +
                 withdrawal + Time_A1_A1:withdrawal +
                 B1:withdrawal + Time_B1_B1:withdrawal +
                 multi_base + Time_A1_A1:multi_base +
                 B1:multi_base + Time_B1_B1:multi_base +
                 alternating + Time_A1_A1:alternating +
                 B1:alternating + Time_B1_B1:alternating,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               correlation = corCAR1(value = 0.4, form = ~ session | study/cluster/case),
               weights = varIdent(form = ~ 1 | phase),
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```


#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.4.vcov <- vcovCR(Model.4, type = "CR2")
Model.4.crve <- coef_test(Model.4, vcov = Model.4.vcov , test = "Satterthwaite")
Model.4.crve$beta <- round(Model.4.crve$beta, 2)
Model.4.crve$SE <- round(Model.4.crve$SE, 2)
Model.4.crve$tstat <- round(Model.4.crve$tstat, 2) %>% format(Model.4.crve$tstat, scientific = FALSE)
Model.4.crve 
```

#### **Variance components**
```{r}
VarCorr(Model.4)
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.4, maxLag=15), alpha = .05)
```

#### **Proportion of outcome variation explained**

$$
\text { Pseudo-}\mathrm{R}^2=\frac{\text { Variance }_{\text {Model 3}}-\text { Variance }_{\text {Model 4}}}{\text { Variance }_{\text {Model 3}}}
$$

```{r, fig.width=7, fig.height=3.8, echo=FALSE}
var_comp.td <- var_comp %>%
  select(level, coef, pseudo_R_sq_M4) %>% tibble()

var_comp.td$level <- factor(var_comp.td$level,levels = c("Study","Cluster","Case", "Repeated measurement"))
var_comp.td$coef <- factor(var_comp.td$coef,levels = c("Residual M", "Residual B2", "Residual A2", "Residual B1", "Residual A1", "Trend B1", "Mean change B1", "Trend A1", "Intercept"))

var_m4_plot <- ggplot(var_comp.td, aes(x=pseudo_R_sq_M4, y=coef, fill=level)) +
  geom_bar(stat="identity", position="stack") +
  labs(x="", y="Pseudo R squared", fill="Multilevels") +
  geom_hline(yintercept=0, linetype="dashed",
             color = "black", size=0.7) +
  theme_minimal(base_size = 11) +
  theme(plot.margin = margin(0, 0, 0, 0)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "#3B3B3B", linewidth = 0.3),
        axis.ticks = element_line(color = "#3B3B3B", linewidth = 0.3),
        strip.text.x = element_text(size = 11, color = "#3B3B3B"),
        axis.text.x = element_text(size = 11, color = "#3B3B3B"),
        axis.text.y = element_text(size = 11, color = "#3B3B3B"),
        axis.title = element_text(size = 11, color = "#3B3B3B"),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.title = element_text(size = 11, color = "#3B3B3B"),
        legend.text = element_text(size = 11, color = "#3B3B3B"),
        legend.title.align = 0.5,
        legend.position = "bottom") + 
  scale_fill_brewer(palette = "Set2") 
var_m4_plot
```

