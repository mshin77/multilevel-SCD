---
title: "Multilevel modeling of single-case data: Level changes and trends during phases moderated by complexity of outcome measures and single-case experimental designs"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    self_contained: false
    thumbnails: false
    lightbox: true
pkgdown:
  as_is: true    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    cache = TRUE,
    message = FALSE, 
    warning = FALSE)
```

This webpage contains raw datasets, outputs, and R codes used for the four-level multilevel modeling. Data analysis scripts were also posted through an online data repository at <https://osf.io/jhsr9/?view_only=46c171d6bc1b485aa5e2e46c76e1175b>.

## Datasets {.tabset}

```{r, echo=FALSE}
suppressPackageStartupMessages({
  library(kableExtra)
  library(dplyr)
  library(nlme)
  library(clubSandwich)
  library(lmeInfo)
  library(texreg)
  library(ggplot2)
})

# var_comp <- read.csv("data/vc.csv")
# wp_data_mlm <- read.csv("data/wp_data.csv")

load("data/wp_mlm.RData")

wp_data_mlm_kb <- wp_data_mlm %>%
    kbl(align = "c") %>%
    kable_styling(
        bootstrap_options = c("striped","hover","condensed"),
        full_width = T,
        font_size = 12,
        fixed_thead = T
    ) %>%
    scroll_box(
        height = "500px"
    )
wp_data_mlm_kb
```

## Model Specification {.tabset}

### Model.1 

#### **Unconditional means model or null model** 

```{r, eval = FALSE}
Model.1 <- lme(outcome ~ 1,
               data = wp_data_mlm,
               method = "REML",
               random = ~ 1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.1.vcov <- vcovCR(Model.1, type = "CR2")
Model.1.crve <- coef_test(Model.1, vcov = Model.1.vcov , test = "Satterthwaite")
Model.1.crve
```

#### **Intraclass correlation (ICC)** 

##### Level 4 (study) 

```{r}
total_var <- as.numeric(VarCorr(Model.1)[[2]]) +
  as.numeric(VarCorr(Model.1)[[4]]) +
  as.numeric(VarCorr(Model.1)[[6]]) +
  as.numeric(VarCorr(Model.1)[[7]]) 

ICC.L4 = as.numeric(VarCorr(Model.1)[[2]]) / total_var
ICC.L4
```

##### Level 3 (cluster) 

```{r}
ICC.L3 = (as.numeric(VarCorr(Model.1)[[4]])) / total_var
ICC.L3
```

##### Level 2 (case) 

```{r}
ICC.L2 = (as.numeric(VarCorr(Model.1)[[6]])) / total_var
format(ICC.L2, scientific=FALSE)
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.1, maxLag=15), alpha = .05)
```

### Model.2 

#### **Random-coefficient model with no moderators**

```{r, eval = FALSE}
Model.2 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))

```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.2.vcov <- vcovCR(Model.2, type = "CR2")
Model.2.crve <- coef_test(Model.2, vcov = Model.2.vcov , test = "Satterthwaite")
Model.2.crve$beta <- round(Model.2.crve$beta, 2)
Model.2.crve$SE <- round(Model.2.crve$SE, 2)
Model.2.crve$tstat <- round(Model.2.crve$tstat, 2) %>% format(Model.2.crve$tstat, scientific = FALSE)
Model.2.crve 
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.2, maxLag=15), alpha = .05)
```

### Model.3

#### **Random-coefficient model with time-varying predictors**

```{r, eval = FALSE}
Model.3 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M +
                 mixed_problem + Time_A1_A1:mixed_problem +
                 B1:mixed_problem + Time_B1_B1:mixed_problem +
                 generalization + Time_A1_A1:generalization +
                 B1:generalization + Time_B1_B1:generalization,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation**

```{r}
options(width = 100)
Model.3.vcov <- vcovCR(Model.3, type = "CR2")
Model.3.crve <- coef_test(Model.3, vcov = Model.3.vcov , test = "Satterthwaite")
Model.3.crve$beta <- round(Model.3.crve$beta, 2)
Model.3.crve$SE <- round(Model.3.crve$SE, 2)
Model.3.crve$tstat <- round(Model.3.crve$tstat, 2) %>% format(Model.3.crve$tstat, scientific = FALSE)
Model.3.crve 
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.3, maxLag=15), alpha = .05)
```

#### **Proportion of outcome variation explained**

$$
\text { Pseudo-}\mathrm{R}^2=\frac{\text { Variance }_{\text {Model 2}}-\text { Variance }_{\text {Model 3}}}{\text { Variance }_{\text {Model 2}}}
$$
```{r, fig.width=7, fig.height=5}
var_comp.td <- var_comp %>% 
  select(level, coef, pseudo_R_sq_M3, pseudo_R_sq_M4) %>% tibble()

var_comp.td$level <- factor(var_comp.td$level,levels = c("Study","Cluster","Case", "Session"))
var_comp.td$coef <- factor(var_comp.td$coef,levels = c("Intercept","Slope A1","Level change B1", "Slope B1", "Residual"))

var_m3_plot <- ggplot(var_comp.td, aes(x=coef, y=pseudo_R_sq_M3, fill=level)) +
  geom_bar(stat="identity", position="stack") +
  labs(x="", y="pseudo R squared (Model 2 to Model 3)", fill="Multilevels") +
  geom_hline(yintercept=0, linetype="dashed",
                color = "black", size=0.7) +
  theme_minimal(base_size = 11) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "#3B3B3B", linewidth = 0.3),
        axis.ticks = element_line(color = "#3B3B3B", linewidth = 0.3),
        strip.text.x = element_text(size = 11, color = "#3B3B3B"), 
        axis.text.x = element_text(size = 11, color = "#3B3B3B"),
        axis.text.y = element_text(size = 11, color = "#3B3B3B"),
        axis.title = element_text(size = 11, color = "#3B3B3B"),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.title = element_text(size = 11, color = "#3B3B3B"),
        legend.text = element_text(size = 11, color = "#3B3B3B"),
        legend.title.align = 0.5,
        legend.position = "bottom")  
var_m3_plot
```

### Model.4

#### **Contextual model with time-invariant predictors (cross-level interactions)** 

```{r, eval = FALSE}
Model.4 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M +
                 mixed_problem + Time_A1_A1:mixed_problem +
                 B1:mixed_problem + Time_B1_B1:mixed_problem +
                 generalization + Time_A1_A1:generalization +
                 B1:generalization + Time_B1_B1:generalization +
                 withdrawal + Time_A1_A1:withdrawal +
                 B1:withdrawal + Time_B1_B1:withdrawal +
                 multi_base + Time_A1_A1:multi_base +
                 B1:multi_base + Time_B1_B1:multi_base +
                 alternating + Time_A1_A1:alternating +
                 B1:alternating + Time_B1_B1:alternating,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))

```

#### **Cluster-robust variance estimation**

```{r}
options(width = 100)
Model.4.vcov <- vcovCR(Model.4, type = "CR2")
Model.4.crve <- coef_test(Model.4, vcov = Model.4.vcov , test = "Satterthwaite")
Model.4.crve$beta <- round(Model.4.crve$beta, 2)
Model.4.crve$SE <- round(Model.4.crve$SE, 2)
Model.4.crve$tstat <- round(Model.4.crve$tstat, 2) %>% format(Model.4.crve$tstat, scientific = FALSE)
Model.4.crve 
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.4, maxLag=15), alpha = .05)
```

#### **Proportion of outcome variation explained**

$$
\text { Pseudo-}\mathrm{R}^2=\frac{\text { Variance }_{\text {Model 2}}-\text { Variance }_{\text {Model 4}}}{\text { Variance }_{\text {Model 2}}}
$$
```{r, fig.width=7, fig.height=5}
var_m4_plot <- ggplot(var_comp.td, aes(x=coef, y=pseudo_R_sq_M4, fill=level)) +
  geom_bar(stat="identity", position="stack") +
  labs(x="", y="pseudo R squared (Model 2 to Model 4)", fill="Multilevels") +
  geom_hline(yintercept=0, linetype="dashed",
                color = "black", size=0.7) +
  theme_minimal(base_size = 11) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(color = "#3B3B3B", linewidth = 0.3),
        axis.ticks = element_line(color = "#3B3B3B", linewidth = 0.3),
        strip.text.x = element_text(size = 11, color = "#3B3B3B"), 
        axis.text.x = element_text(size = 11, color = "#3B3B3B"),
        axis.text.y = element_text(size = 11, color = "#3B3B3B"),
        axis.title = element_text(size = 11, color = "#3B3B3B"),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10)),
        legend.title = element_text(size = 11, color = "#3B3B3B"),
        legend.text = element_text(size = 11, color = "#3B3B3B"),
        legend.title.align = 0.5,
        legend.position = "bottom")  
var_m4_plot
```

### Model.5

#### **Contextual model with cross-level interactions and AR(1) correlation structure (corCAR1)** 

```{r, eval = FALSE}
Model.5 <- update(Model.4, correlation = corCAR1(value = 0.4, form = ~ session | study/cluster/case))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.5.vcov <- vcovCR(Model.5, type = "CR2")
Model.5.crve <- coef_test(Model.5, vcov = Model.5.vcov , test = "Satterthwaite")
Model.5.crve$beta <- round(Model.5.crve$beta, 2)
Model.5.crve$SE <- round(Model.5.crve$SE, 2)
Model.5.crve$tstat <- round(Model.5.crve$tstat, 2) %>% format(Model.5.crve$tstat, scientific = FALSE)
Model.5.crve 
```

#### **Comparing likelihoods of fitted objects**

```{r}
M4_M5 <- anova(Model.4, Model.5)
M4_M5
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.5, maxLag=15), alpha = .05)
```

### Model.6

#### **Contextual model with cross-level interactions and heterogeneous AR(1) correlation structure (corCAR1)** 

```{r, eval = FALSE}
Model.6 <- update(Model.5, weights = varIdent(form = ~ 1 | phase))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.6.vcov <- vcovCR(Model.6, type = "CR2")
Model.6.crve <- coef_test(Model.6, vcov = Model.6.vcov , test = "Satterthwaite")
Model.6.crve$beta <- round(Model.6.crve$beta, 2)
Model.6.crve$SE <- round(Model.6.crve$SE, 2)
Model.6.crve$tstat <- round(Model.6.crve$tstat, 2) %>% format(Model.6.crve$tstat, scientific = FALSE)
Model.6.crve 
```

#### **Comparing likelihoods of fitted objects**

```{r}
M5_M6 <- anova(Model.5, Model.6)
M5_M6
```

#### **Autocorrelation**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.6, maxLag=15), alpha = .05)
```
