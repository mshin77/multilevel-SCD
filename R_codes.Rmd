---
title: "Meta-analysis using multilevel modeling: Acquisition, maintenance, and generalization of word problem solving"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    self_contained: false
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  message = FALSE, 
  warning = FALSE)
```

This webpage contains the coded dataset, outputs, and R codes used for the four-level multilevel modeling in Authors (2023). Data analysis scripts have been posted through an online data repository, accessible at <https://osf.io/8wbta/?view_only=31ca7d3193104652b39dbb4a516a5f00>.

```{r, echo = FALSE}
suppressPackageStartupMessages({
  library(magrittr)
  library(kableExtra)
  library(fastDummies)
  library(imputeTS)
  library(DT)
  library(tidyr)
  library(dplyr)
  library(downloadthis)
  library(ggh4x)
  library(broom)
  library(gridExtra)
  library(SingleCaseES)
  library(nlme)
  library(clubSandwich)
  library(lmeInfo)
  library(msm)
})
```

# Preprocess Data 

```{r, eval = FALSE}
wp_data <- read.csv("data/wp_data.csv")

# Create dummy variables

wp_data_dummy <- wp_data %>% dummy_cols(select_columns = c('designType', 'phase', 'complexityMeasure')) 
colnames(wp_data_dummy) <- sub(".*_", "", colnames(wp_data_dummy))
wp_data_dummy %<>% select(authorYear, study, designType, multiBase, multiProbe, cluster, case, phase, A, B, M, session, outcome, complexityMeasure, singleType, combinedType, generalization)

# Center times and create interaction terms 

wp_data_combined <- wp_data_dummy %>%
  group_by(study, cluster, case) %>%
  mutate(min_A = ifelse(A == 1, min(session[A == 1]), NA),
         min_B = ifelse(B == 1, min(session[B == 1]), NA),
         min_M = ifelse(M == 1, min(session[M == 1]), NA))

wp_data_mlm <- wp_data_combined %>%
  group_by(study, cluster, case) %>%
  mutate(level_AB = as.integer(I(session >= first(na.omit(min_B))))) %>%
  mutate(level_BM = as.integer(I(session >= first(na.omit(min_M))))) %>%
  mutate(time_A = session - first(na.omit(min_A))) %>%
  mutate(time_B = session - first(na.omit(min_B))) %>%
  mutate(time_M = session - first(na.omit(min_M))) %>%
  mutate(slope_AB = time_B*level_AB) %>%
  mutate(slope_BM = time_M*level_BM) %>%
  select(-min_A, -min_B, -min_M)

wp_data_mlm <- na_replace(wp_data_mlm, 0)

wp_data_mlm_kb <- wp_data_mlm %>% 
  kbl(align = "c") %>%
  kable_styling(
    bootstrap_options = c("striped","hover","condensed"),
    full_width = T,
    font_size = 12,
    fixed_thead = T) %>%
  scroll_box(height = "400px")

wp_data_mlm %>%
  download_this(
    output_name = "Authors (2023) Dataset",
    output_extension = ".xlsx",
    button_label = "Download",
    button_type = "default",
    has_icon = TRUE,
    icon = "fa fa-save",
    class = "buttom_small")
```

```{r, echo = FALSE}
load("data/wp_data.RData")

wp_data_mlm_kb
```

# Descriptive statistics {.tabset}

## Cases 

```{r}
wp_data_mlm %>%
  group_by(authorYear, cluster, case) %>% 
  summarise(across(where(is.numeric), list(min = min, max = max, mean = mean, SD = sd, count = sum))) %>% 
  mutate_at(c("session_mean", "session_SD", "outcome_mean", "outcome_SD", 
              "A_mean", "A_SD", "B_mean", "B_SD", "M_mean", "M_SD"), round, 2) %>%
  mutate_at("session_max", round, 0) %>%
  select(authorYear, cluster, case, A_min, A_max, A_mean, A_SD, A_count, 
         B_min, B_max, B_mean, B_SD,
         M_min, M_max, M_mean, M_SD) %>%
  kbl(align = "c") %>%
  kable_styling(
    bootstrap_options = c("striped","hover","condensed"),
    full_width = T,
    font_size = 12,
    fixed_thead = T) %>%
  scroll_box(height = "400px")
```

## Clusters 

```{r}
wp_data_mlm %>%
  group_by(authorYear, cluster) %>% 
  summarise(across(where(is.numeric), 
                   list(min = min, max = max, mean = mean, SD = sd, count = sum))) %>% 
  mutate_at(c("session_mean", "session_SD", "outcome_mean", "outcome_SD",
              "A_mean", "A_SD", "B_mean", "B_SD", "M_mean", "M_SD"), round, 2) %>%
  mutate_at("session_max", round, 0) %>%
  select(authorYear, cluster, A_min, A_max, A_mean, A_SD, A_count, 
         B_min, B_max, B_mean, B_SD,
         M_min, M_max, M_mean, M_SD) %>%
  kbl(align = "c") %>%
  kable_styling(
    bootstrap_options = c("striped","hover","condensed"),
    full_width = T,
    font_size = 12,
    fixed_thead = T) %>%
  scroll_box(height = "400px")
```

## Studies 

```{r}
wp_data_mlm %>%
  group_by(authorYear) %>% 
  summarise(across(where(is.numeric), list(min = min, max = max, mean = mean, SD = sd, count = sum))) %>% 
  mutate_at(c("session_mean", "session_SD", "outcome_mean", "outcome_SD",
              "A_mean", "A_SD", "B_mean", "B_SD", "M_mean", "M_SD"), round, 2) %>%
  mutate_at("session_max", round, 0) %>%
  select(authorYear, A_min, A_max, A_mean, A_SD, A_count, 
         B_min, B_max, B_mean, B_SD,
         M_min, M_max, M_mean, M_SD) %>%
  kbl(align = "c") %>%
  kable_styling(
    bootstrap_options = c("striped","hover","condensed"),
    full_width = T,
    font_size = 12,
    fixed_thead = T) %>%
  scroll_box(height = "400px")
```

<br>

# Model Specification {.tabset}

## Model.1 

#### **Null model** 

```{r, eval = FALSE, class.source = 'fold-show'}
Model.1 <- lme(outcome ~ 1,
               data = wp_data_mlm,
               method = "REML",
               random = ~ 1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation**

```{r}
options(width = 100)
Model.1.vcov <- vcovCR(Model.1, type = "CR2")
Model.1.crve <- coef_test(Model.1, vcov = Model.1.vcov , test = "Satterthwaite")

# Calculate standardized mean difference (d)

Model.1.crve$sig <-
  case_when(
    is.na(Model.1.crve$p_Satt) ~ "",
    Model.1.crve$p_Satt < 0.001 ~ "***",
    Model.1.crve$p_Satt < 0.01 ~ "**",
    Model.1.crve$p_Satt < 0.05 ~ "*",
    TRUE ~ ""
  )

Model.1.d <- Model.1.crve %>% 
  mutate(d = 2 * abs(tstat) / sqrt(df_Satt)) %>%
  select(d)

Model.1.crve.combined <- cbind(Model.1.crve, Model.1.d) %>%
  mutate_if(is.numeric, ~round(., 3)) %>% tibble() %>%
  rename(Estimate = beta,
         "t-stat" = tstat,
         "d.f. (Satt)" = df_Satt,
         "p-val (Satt)" = p_Satt)

Model.1.crve.combined %>% 
  datatable(options = list(
    initComplete = JS("
      function(settings, json) {
        $(this.api().table().header()).css({
          'font-family': 'Arial, sans-serif',
          'font-size': '13px',
        });
      }
    ")
  )) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = "13px")
```

#### **Variance components**

```{r, comment = NA, class.source = 'fold-show'}
intervals(Model.1, which = "var-cov")
```

```{r, comment = NA, class.source = 'fold-show'}
VarCorr(Model.1)
```

```{r,comment = NA, class.source = 'fold-show'}
sqrt(diag(varcomp_vcov(Model.1))) # Standard errors of variances 
```

#### **Intraclass correlation (ICC)** 

$$
\text { Level } 4=\frac{\tau_{v_0}^2}{\tau_{v_0}^2+\tau_{u_0}^2+\tau_{r_0}^2+\sigma^2} \text {, Level } 3=\frac{\tau_{u_0}^2}{\tau_{v_0}^2+\tau_{u_0}^2+\tau_{r_0}^2+\sigma^2} \text {, Level } 2=\frac{\tau_{r_0}^2}{\tau_{v_0}^2+\tau_{u_0}^2+\tau_{r_0}^2+\sigma^2} \text {. }
$$

**Level 4 (study)**

```{r, comment = NA}
total_var <- as.numeric(VarCorr(Model.1)[[2]]) +
  as.numeric(VarCorr(Model.1)[[4]]) +
  as.numeric(VarCorr(Model.1)[[6]]) +
  as.numeric(VarCorr(Model.1)[[7]]) 

ICC.L4 = as.numeric(VarCorr(Model.1)[[2]]) / total_var
ICC.L4
```
**Level 3 (cluster)**

```{r, comment = NA}
ICC.L3 = (as.numeric(VarCorr(Model.1)[[4]])) / total_var
ICC.L3
```

**Level 2 (case)** 

```{r, comment = NA}
ICC.L2 = (as.numeric(VarCorr(Model.1)[[6]])) / total_var
format(ICC.L2, scientific=FALSE)
```

#### **Autocorrelation**

```{r, fig.align = 'center', fig.width = 7, fig.height = 4}
acf_Model.1 <- ACF(Model.1, maxLag=14)
acf_Model.1.plot <- plot(acf_Model.1, alpha = .05)
acf_Model.1.value <- tidy(acf_Model.1$ACF) %>%
  mutate(acf = round(x, 2)) %>%
  select(acf)
acf_Model.1.tb <- tableGrob(acf_Model.1.value[1:10,], rows = NULL, theme = ttheme_default(base_size = 10))
grid.arrange(acf_Model.1.plot, acf_Model.1.tb, nrow = 1, widths = c(0.85, 0.15))
```

## Model.2 

#### **AR(1) correlation structure**

```{r, eval = FALSE, class.source = 'fold-show'}
Model.2 <- lme(outcome ~
                 time_A + level_AB + slope_AB + level_BM + slope_BM,
               data = wp_data_mlm,
               method = "REML",
               random = ~ level_AB | study/cluster/case,
               correlation = corCAR1(value = 0.19, form = ~ session | study/cluster/case),
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation**

```{r}
options(width = 100)
Model.2.vcov <- vcovCR(Model.2, type = "CR2")
Model.2.crve <- coef_test(Model.2, vcov = Model.2.vcov , test = "Satterthwaite")

# Calculate standardized mean difference (d)

Model.2.crve$sig <-
  case_when(
    is.na(Model.2.crve$p_Satt) ~ "",
    Model.2.crve$p_Satt < 0.001 ~ "***",
    Model.2.crve$p_Satt < 0.01 ~ "**",
    Model.2.crve$p_Satt < 0.05 ~ "*",
    TRUE ~ ""
  )

Model.2.d <- Model.2.crve %>% 
  mutate(d = 2 * abs(tstat) / sqrt(df_Satt)) %>%
  select(d)

Model.2.crve.combined <- cbind(Model.2.crve, Model.2.d) %>%
  mutate_if(is.numeric, ~round(., 3)) %>% tibble() %>%
  rename(Estimate = beta,
         "t-stat" = tstat,
         "d.f. (Satt)" = df_Satt,
         "p-val (Satt)" = p_Satt)

Model.2.crve.combined %>% 
  datatable(options = list(
    initComplete = JS("
      function(settings, json) {
        $(this.api().table().header()).css({
          'font-family': 'Arial, sans-serif',
          'font-size': '13px',
        });
      }
    ")
  )) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = "13px")
```

#### **Variance components**

```{r, comment = NA, class.source = 'fold-show'}
intervals(Model.2, which = "var-cov")
```

```{r, comment = NA, class.source = 'fold-show'}
VarCorr(Model.2)
```

```{r,comment = NA, class.source = 'fold-show'}
sqrt(diag(varcomp_vcov(Model.2))) # Standard errors of variances 
```

#### **Autocorrelation**

```{r, fig.align = 'center', fig.width = 7, fig.height = 4}
acf_Model.2 <- ACF(Model.2, maxLag=14)
acf_Model.2.plot <- plot(acf_Model.2, alpha = .05)
acf_Model.2.value <- tidy(acf_Model.2$ACF) %>%
  mutate(acf = round(x, 2)) %>%
  select(acf)
acf_Model.2.tb <- tableGrob(acf_Model.2.value[1:10,], rows = NULL, theme = ttheme_default(base_size = 10))
grid.arrange(acf_Model.2.plot, acf_Model.2.tb, nrow = 1, widths = c(0.85, 0.15))
```

## Model.3

#### **Types of word problem Measures as a moderator**

```{r, eval = FALSE, class.source = 'fold-show'}
Model.3 <- lme(outcome ~
                 time_A + level_AB + slope_AB + level_BM + slope_BM + 
                 combinedType + time_A:combinedType + level_AB:combinedType + slope_AB:combinedType + level_BM:combinedType + slope_BM:combinedType +
                 generalization + time_A:generalization + level_AB:generalization + slope_AB:generalization + level_BM:generalization + slope_BM:generalization,
               data = wp_data_mlm,
               method = "REML",
               random = ~ level_AB | study/cluster/case,
               correlation = corCAR1(value = 0.4, form = ~ session | study/cluster/case),
               weights = varIdent(form = ~ 1 | phase),
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation**

```{r}
options(width = 100)
Model.3.vcov <- vcovCR(Model.3, type = "CR2")
Model.3.crve <- coef_test(Model.3, vcov = Model.3.vcov , test = "Satterthwaite")

# Calculate standardized mean difference (d)

Model.3.crve$sig <-
  case_when(
    is.na(Model.3.crve$p_Satt) ~ "",
    Model.3.crve$p_Satt < 0.001 ~ "***",
    Model.3.crve$p_Satt < 0.01 ~ "**",
    Model.3.crve$p_Satt < 0.05 ~ "*",
    TRUE ~ ""
  )

Model.3.d <- Model.3.crve %>% 
  mutate(d = 2 * abs(tstat) / sqrt(df_Satt)) %>%
  select(d)

Model.3.crve.combined <- cbind(Model.3.crve, Model.3.d) %>%
  mutate_if(is.numeric, ~round(., 3)) %>% tibble() %>%
  rename(Estimate = beta,
         "t-stat" = tstat,
         "d.f. (Satt)" = df_Satt,
         "p-val (Satt)" = p_Satt)

Model.3.crve.combined %>% 
  datatable(options = list(
    initComplete = JS("
      function(settings, json) {
        $(this.api().table().header()).css({
          'font-family': 'Arial, sans-serif',
          'font-size': '13px',
        });
      }
    ")
  )) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = "13px")
```

#### **Variance components**

```{r, comment = NA, class.source = 'fold-show'}
intervals(Model.3, which = "var-cov")
```

```{r, comment = NA, class.source = 'fold-show'}
VarCorr(Model.3)
```

```{r, comment = NA, class.source = 'fold-show'}
sqrt(diag(varcomp_vcov(Model.3))) # Standard errors of variances 
```

#### **Autocorrelation**

```{r, fig.align = 'center', fig.width = 7, fig.height = 4}
acf_Model.3 <- ACF(Model.3, maxLag=14)
acf_Model.3.plot <- plot(acf_Model.3, alpha = .05)
acf_Model.3.value <- tidy(acf_Model.3$ACF) %>%
  mutate(acf = round(x, 2)) %>%
  select(acf)
acf_Model.3.tb <- tableGrob(acf_Model.3.value[1:10,], rows = NULL, theme = ttheme_default(base_size = 10))
grid.arrange(acf_Model.3.plot, acf_Model.3.tb, nrow = 1, widths = c(0.85, 0.15))
```
