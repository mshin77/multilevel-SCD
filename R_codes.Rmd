---
title: "Multilevel modeling of single-case data: Level changes and trends during phases moderated by complexity of outcome measures and single-case experimental designs"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    self_contained: false
    thumbnails: false
    lightbox: true
pkgdown:
  as_is: true    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    cache = TRUE,
    message = FALSE, 
    warning = FALSE)
```

This webpage contains raw datasets, outputs, and R codes used for the four-level multilevel modeling. Data analysis scripts were also posted through an online data repository at <https://osf.io/jhsr9/?view_only=46c171d6bc1b485aa5e2e46c76e1175b>.

## Datasets {.tabset}

```{r, echo=FALSE}
suppressPackageStartupMessages({
  library(kableExtra)
  library(dplyr)
  library(nlme)
  library(clubSandwich)
  library(lmeInfo)
  library(texreg)
})

# wp_data_mlm <- read.csv("data/wp_data.csv")

load("data/wp_mlm.RData")

wp_data_mlm_kb <- wp_data_mlm %>%
    kbl(align = "c") %>% 
    kable_styling(
        bootstrap_options = c("striped","hover","condensed"),
        full_width = T,
        font_size = 12,
        fixed_thead = T
    ) %>% 
    scroll_box(
        height = "500px"
    )
wp_data_mlm_kb
```

## Model Specification {.tabset}

### Model.1 

#### **Unconditional means model or null model** 

```{r, eval=FALSE}
Model.1 <- lme(outcome ~ 1,
               data = wp_data_mhlm,
               method = "REML",
               random = ~ 1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.1.vcov <- vcovCR(Model.1, type = "CR2")
Model.1.crve <- coef_test(Model.1, vcov = Model.1.vcov , test = "Satterthwaite")
Model.1.crve
```

#### **Intraclass correlation (ICC)** 

##### Level 4 (study) 

```{r}
total_var <- as.numeric(VarCorr(Model.1)[[2]]) +
  as.numeric(VarCorr(Model.1)[[4]]) +
  as.numeric(VarCorr(Model.1)[[6]]) +
  as.numeric(VarCorr(Model.1)[[7]]) 

ICC.L4 = as.numeric(VarCorr(Model.1)[[2]]) / total_var
ICC.L4
```

##### Level 3 (cluster) 

```{r}
ICC.L3 = (as.numeric(VarCorr(Model.1)[[4]])) / total_var
ICC.L3
```

##### Level 2 (case) 

```{r}
ICC.L2 = (as.numeric(VarCorr(Model.1)[[6]])) / total_var
format(ICC.L2, scientific=FALSE)
```

##### Level 1 (repeated measurement) 

```{r}
ICC.L1 = (as.numeric(VarCorr(Model.1)[[7]])) / total_var
ICC.L1
```

#### **Autocorrelation (serial correlation)**

```{r, fig.width=6, fig.height=4}
plot(ACF(Model.1, maxLag=15), alpha = .05)
```

### Model.2 

#### **Random-coefficient model**

```{r, eval=FALSE}
Model.2 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +/oo
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.2.vcov <- vcovCR(Model.2, type = "CR2")
Model.2.crve <- coef_test(Model.2, vcov = Model.2.vcov , test = "Satterthwaite")
Model.2.crve
```

### Model.3

#### **Contextual model with cross-level interactions**

```{r, eval=FALSE}
Model.3 <- lme(outcome ~
                 Time_A1_A1 +
                 B1 + Time_B1_B1 +
                 A2 + Time_A2_A2 +
                 B2 + Time_B2_B2 +
                 M + Time_M_M +
                 mixed_problem + Time_A1_A1:mixed_problem +
                 B1:mixed_problem + Time_B1_B1:mixed_problem +
                 generalization + Time_A1_A1:generalization +
                 B1:generalization + Time_B1_B1:generalization +
                 withdrawal + Time_A1_A1:withdrawal +
                 B1:withdrawal + Time_B1_B1:withdrawal +
                 multi_base + Time_A1_A1:multi_base +
                 B1:multi_base + Time_B1_B1:multi_base +
                 alternating + Time_A1_A1:alternating +
                 B1:alternating + Time_B1_B1:alternating,
               data = wp_data_mlm,
               method = "REML",
               random = ~ Time_A1_A1 + B1 + Time_B1_B1 | study/cluster/case,
               control=list(maxIter=100,msMaxIter=100,tolerance=1e-3,
                            opt="optim",optimMethod="BFGS"))

```

#### **Cluster-robust variance estimation**

```{r}
options(width = 100)
Model.3.vcov <- vcovCR(Model.3, type = "CR2")
Model.3.crve <- coef_test(Model.3, vcov = Model.3.vcov , test = "Satterthwaite")
Model.3.crve
```

### Model.4

#### **Contextual model with cross-level interactions and AR(1) correlation structure (corAR1)** 

```{r, eval=FALSE}
Model.4 <- update(Model.3, correlation = corCAR1(value = 0.4, form = ~ session | study/cluster/case))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.4.vcov <- vcovCR(Model.4, type = "CR2")
Model.4.crve <- coef_test(Model.4, vcov = Model.4.vcov , test = "Satterthwaite")
Model.4.crve
```

#### **Comparing likelihoods of fitted objects**

```{r}
M3_M4 <- anova(Model.3, Model.4)
M3_M4
```

### Model.5

#### **Contextual model with cross-level interactions and heterogenous AR(1) correlation structure (corAR1)** 

```{r, eval=FALSE}
Model.5 <- update(Model.4, weights = varIdent(form = ~ 1 | phase))
```

#### **Cluster-robust variance estimation** 

```{r}
options(width = 100)
Model.5.vcov <- vcovCR(Model.5, type = "CR2")
Model.5.crve <- coef_test(Model.5, vcov = Model.5.vcov , test = "Satterthwaite")
Model.5.crve 
```

#### **Comparing likelihoods of fitted objects**

```{r}
M4_M5 <- anova(Model.4, Model.5)
M4_M5
```

```{r}
save(wp_data_mlm, Model.1, Model.2, Model.3, Model.4, Model.5, M3_M4, M4_M5, file = "data/wp_mlm.RData")
```
